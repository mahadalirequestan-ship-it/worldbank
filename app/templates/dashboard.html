<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMRS Databank</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flag-icons/css/flag-icons.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Light theme */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --border-light: #f1f5f9;
            --accent-primary: #3b82f6;
            --accent-secondary: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-dark: rgba(0, 0, 0, 0.2);
        }

        [data-theme="dark"] {
            /* Dark theme */
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --border-light: #334155;
            --accent-primary: #60a5fa;
            --accent-secondary: #3b82f6;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
            --shadow: rgba(0, 0, 0, 0.5);
            --shadow-dark: rgba(0, 0, 0, 0.8);
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        /* Header Styles */
        .main-header {
            background: var(--bg-secondary);
            border-bottom: 2px solid var(--border-color);
            padding: 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px var(--shadow);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .header-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 80px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .header-logo .logo-icon {
            width: 115px;
            height: 115px;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-logo .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .header-logo .logo-text h1 {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-logo .logo-text span {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .header-search {
            flex: 1;
            max-width: 500px;
            margin: 0 40px;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            padding: 0 20px;
            transition: all 0.3s ease;
        }

        .search-container:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .search-container i {
            color: var(--text-muted);
            margin-right: 12px;
        }

        .search-container input {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 1rem;
            padding: 15px 0;
            outline: none;
        }

        .search-container input::placeholder {
            color: var(--text-muted);
        }

        .search-btn {
            background: var(--accent-primary);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .search-btn:hover {
            background: var(--accent-secondary);
            transform: scale(1.1);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        /* Language Selector */
        .language-selector {
            position: relative;
        }

        .lang-current {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-primary);
        }

        .lang-current:hover {
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .flag-icon {
            width: 20px;
            height: 15px;
            border-radius: 3px;
        }

        .lang-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 8px 25px var(--shadow-dark);
            min-width: 150px;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 1000;
            margin-top: 5px;
        }

        .lang-dropdown.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .lang-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .lang-option:hover {
            background: var(--bg-tertiary);
        }

        .lang-option:first-child {
            border-radius: 8px 8px 0 0;
        }

        .lang-option:last-child {
            border-radius: 0 0 8px 8px;
        }

        /* Theme Toggle */
        .header-controls .theme-toggle {
            position: relative;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            padding: 4px;
            box-shadow: none;
            top: auto;
            right: auto;
        }

        .toggle-switch {
            position: relative;
            align-items: center;
            width: 64px;
            height: 32px;
            background: var(--bg-tertiary);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            background: var(--accent-primary);
            border-radius: 50%;
            top: 4px;
            left: 4px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px var(--shadow);
        }

        .toggle-switch.active::before {
            transform: translateX(32px);
            background: var(--accent-secondary);
        }

        .toggle-icons {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            pointer-events: none;
        }

        .toggle-icons i {
            font-size: 12px;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .toggle-switch.active .fa-sun {
            color: var(--warning);
        }

        .toggle-switch:not(.active) .fa-moon {
            color: var(--accent-primary);
        }

        /* Social Links */
        .social-links {
            display: flex;
            gap: 8px;
        }

        .social-link {
            width: 40px;
            height: 40px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .social-link:hover {
            transform: translateY(-2px);
            color: white;
            border-color: transparent;
        }

        .social-link[href*="telegram"]:hover {
            background: #0088cc;
        }

        .social-link[href*="instagram"]:hover {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        }

        .social-link[href*="facebook"]:hover {
            background: #1877f2;
        }

        .social-link[href*="youtube"]:hover {
            background: #ff0000;
        }

        /* Container */
        .container {
            display: flex;
            min-height: 100vh;
            margin-top: 80px;
        }

        /* Sidebar */
        .sidebar {
            width: 560px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
            position: fixed;
            height: calc(100vh - 80px);
            top: 80px;
            left: 0;
            z-index: 100;
            transition: all 0.3s ease;
            box-shadow: 4px 0 20px var(--shadow);
        }

        .sidebar h2 {
            color: var(--text-primary);
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 3px solid var(--accent-primary);
            padding-bottom: 15px;
            font-weight: 700;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Filter Section */
        .filter-section {
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-secondary);
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s ease;
        }

        .filter-section:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px var(--shadow-dark);
        }

        .section-header {
            background: var(--bg-tertiary);
            padding: 18px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .section-header:hover {
            background: var(--border-color);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.1rem;
        }

        .section-title i {
            color: var(--accent-primary);
            font-size: 1.2rem;
        }

        .section-stats {
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .selected-count {
            color: var(--accent-primary);
            font-weight: 700;
        }

        .section-content {
            max-height: 480px;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .section-content.collapsed {
            max-height: 0;
        }

        /* Controls */
        .filter-controls {
            padding: 18px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }

        .controls-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 0.95rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .control-btn {
            padding: 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 10px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            min-width: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .control-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        /* Alphabet Filter */
        .alphabet-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 15px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            justify-content: center;
        }

        .alphabet-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .alphabet-btn:hover {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .alphabet-btn.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .alphabet-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Items List - UNIFIED STYLES */
        .items-list {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px 0;
        }

        /* UNIVERSAL FILTER ITEM STYLES */
        .filter-item {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 6px;
            margin: 0 8px 4px 8px;
            min-height: 40px;
        }

        .filter-item:hover {
            background: var(--bg-tertiary);
            transform: translateX(4px);
        }

        /* UNIVERSAL ICON STYLES */
        .filter-item-icon {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 0.7rem;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* UNIVERSAL CHECKBOX STYLES */
        .filter-item input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent-primary);
            flex-shrink: 0;
        }

        /* UNIVERSAL LABEL STYLES */
        .filter-item label {
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-primary);
            flex: 1;
            font-weight: 500;
            line-height: 1.3;
        }

        /* UNIVERSAL COUNT STYLES */
        .filter-item .count {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-left: 8px;
            background: var(--bg-tertiary);
            padding: 3px 6px;
            border-radius: 4px;
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Grid Layout for Countries */
        .countries-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2px;
            padding: 5px;
        }

        .countries-grid .filter-item {
            margin: 0;
            padding: 6px 10px;
            font-size: 0.85rem;
        }

        .countries-grid .filter-item label {
            font-size: 0.9rem;
        }

        .countries-grid .filter-item-icon {
            width: 20px;
            height: 20px;
            font-size: 0.6rem;
            margin-right: 8px;
        }

        .countries-grid .filter-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 8px;
        }

        /* Series/Products List - UNIFIED WITH COUNTRIES */
        #seriesList .filter-item {
            padding: 8px 15px;
            margin: 0 8px 4px 8px;
            min-height: 40px;
        }

        #seriesList .filter-item-icon {
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            margin-right: 10px;
            background: linear-gradient(135deg, #559bf9, #559bf9);
        }

        #seriesList .filter-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 10px;
        }

        #seriesList .filter-item label {
            font-size: 0.9rem;
            line-height: 1.3;
        }

        #seriesList .filter-item .count {
            font-size: 0.8rem;
            padding: 3px 6px;
        }

        /* Years Grid - UNIFIED STYLES */
        .years-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 8px;
            padding: 15px;
        }

        .year-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            min-height: 40px;
            position: relative;
        }

        .year-item:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
            border-color: var(--accent-primary);
        }

        .year-item input {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent-primary);
            flex-shrink: 0;
            margin-left: 25px;
        }

        .year-item label {
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        /* Year Icon */
        .year-item::before {
            content: '!';
            position: absolute;
            left: 8px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            border-radius: 50%;
            background: linear-gradient(135deg, #559bf9, #559bf9);
        }

        /* Trade Direction Grid */
        .trade-direction-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 15px;
        }

        .trade-direction-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            min-height: 50px;
            position: relative;
        }

        .trade-direction-item:hover {
            background: var(--bg-tertiary);
            transform: translateY(-1px);
            border-color: var(--accent-primary);
        }

        .trade-direction-item input {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent-primary);
            flex-shrink: 0;
            margin-left: 35px;
        }

        .trade-direction-item label {
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
        }

        /* Trade Direction Icons */
        .trade-direction-item::before {
            content: '';
            position: absolute;
            left: 12px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            border-radius: 50%;
            color: white;
            font-weight: bold;
        }

        .trade-direction-item[data-type="export"]::before {
            content: '↗';
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .trade-direction-item[data-type="import"]::before {
            content: '↙';
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            margin-left: 540px;
        }

        /* Preview Panel */
        .preview-panel {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 50px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 24px var(--shadow);
            transition: all 0.3s ease;
        }

        .preview-icon {
            font-size: 5rem;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
        }

        .preview-panel h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-size: 2rem;
            font-weight: 700;
        }

        .preview-panel p {
            color: var(--text-secondary);
            margin-bottom: 35px;
            font-size: 1.15rem;
            line-height: 1.6;
        }

        .requirements {
            margin: 35px 0;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .requirement {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            padding: 16px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .requirement.completed {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
            color: var(--success);
            transform: scale(1.02);
        }

        .requirement i {
            margin-right: 12px;
            width: 24px;
            font-size: 1.2rem;
        }

        .requirement.completed i {
            color: var(--success);
        }

        .apply-btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.15rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            min-width: 220px;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }

        .apply-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        .apply-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Results Panel */
        .results-panel {
            display: none;
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 24px var(--shadow);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .results-header h3 {
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .results-count {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
        }

        /* Current Selection Summary */
        .current-selection-summary {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--border-light));
            border: 2px solid var(--border-color);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .selection-tags {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .selection-tag-group {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s ease;
        }

        .selection-tag-group:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-dark);
        }

        .selection-tag-group strong {
            display: block;
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 600;
        }

        .selection-tag-group span {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 1rem;
            line-height: 1.5;
        }

        .new-search-section {
            text-align: center;
            padding-top: 25px;
            border-top: 2px solid var(--border-color);
        }

        .new-search-hint {
            margin: 12px 0 0 0;
            font-size: 0.95rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Enhanced Search Styles */
        .enhanced-search {
            position: relative;
        }

        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-top: none;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 8px 25px var(--shadow-dark);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-dropdown.show {
            display: block;
        }

        .search-result-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-light);
        }

        .search-result-item:hover {
            background: var(--bg-tertiary);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .search-result-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            gap: 15px;
        }

        .search-result-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Chart Controls Styles */
        .chart-controls {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 20px;
            padding: 20px;
            box-shadow: 0 4px 16px var(--shadow);
        }

        .controls-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .controls-header h4 {
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .view-toggles {
            display: flex;
            gap: 8px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .view-btn {
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .view-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        .view-btn.active {
            background: var(--accent-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        /* Country Selector Styles */
        .country-selector-section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 15px;
            padding: 20px;
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s ease;
        }

        .selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .selector-header h4 {
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .selector-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .country-select {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
            font-weight: 500;
        }

        .country-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .country-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 8px;
        }

        /* Selected Country Info */
        .selected-country-info {
            margin-top: 15px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .country-card {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--border-light));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 18px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .country-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-dark);
            border-color: var(--accent-primary);
        }

        .country-flag {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .country-details {
            flex: 1;
        }

        .country-details h5 {
            margin: 0 0 8px 0;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .country-details p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .country-metrics {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .metric {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .metric-value {
            font-size: 1rem;
            color: var(--accent-primary);
            font-weight: 700;
        }

        /* Chart Container */
        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 20px;
            padding: 25px;
            box-shadow: 0 4px 16px var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .chart-header h4 {
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .chart-controls-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chart-select {
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .chart-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .chart-content {
            position: relative;
            height: 540px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .chart-content canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Metadata Container */
        .metadata-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-top: 20px;
            padding: 25px;
            box-shadow: 0 4px 16px var(--shadow);
        }

        .metadata-header h4 {
            color: var(--text-primary);
            margin: 0 0 25px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: 600;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .metadata-section-selector {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
        }

        .section-info {
            margin: 0;
        }

        .section-info p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-info i {
            color: var(--accent-primary);
        }

        .section-info strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metadata-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .metadata-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow-dark);
            border-color: var(--accent-primary);
        }

        .metadata-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .metadata-info h5 {
            margin: 0 0 5px 0;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 600;
        }

        .metadata-info p {
            margin: 0;
            color: var(--accent-primary);
            font-size: 1.1rem;
            font-weight: 700;
        }

        .text-success {
            color: var(--success) !important;
        }

        .text-error {
            color: var(--error) !important;
        }

        /* Detailed Stats */
        .detailed-stats {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .detailed-stats h5 {
            color: var(--text-primary);
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .stats-table {
            max-height: 300px;
            overflow-y: auto;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .stats-row:hover {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding-left: 10px;
            padding-right: 10px;
        }

        .stats-row:last-child {
            border-bottom: none;
        }

        .stats-country {
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats-value {
            color: var(--accent-primary);
            font-weight: 600;
            font-size: 0.95rem;
        }

        /* Results Table */
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px var(--shadow);
            background: var(--bg-secondary);
        }

        .results-table th {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 15px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .results-table td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .results-table tr:hover {
            background: var(--bg-tertiary);
        }

        .results-table tr:nth-child(even) {
            background: var(--bg-tertiary);
        }

        .year-badge {
            background: var(--accent-primary);
            color: white;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Loading States - UNIFIED */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            grid-column: 1 / -1;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Chart Loading */
        .chart-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: var(--text-muted);
        }

        .chart-loading .spinner {
            width: 40px;
            height: 40px;
            margin-bottom: 15px;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 18px 24px;
            border-radius: 12px;
            box-shadow: 0 8px 24px var(--shadow-dark);
            transform: translateX(100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            max-width: 400px;
            font-weight: 500;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: var(--error);
        }

        .toast.info {
            background: var(--accent-primary);
        }

        /* No Data States - UNIFIED */
        .no-data {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.9rem;
            grid-column: 1 / -1;
        }

        /* Hover Effects - UNIFIED */
        .filter-item:hover .filter-item-icon {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        .year-item:hover::before {
            transform: scale(1.1);
        }

        /* Focus States - UNIFIED */
        .filter-item input[type="checkbox"]:focus,
        .year-item input:focus {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
            border-radius: 3px;
        }

        /* Selection States - UNIFIED */
        .filter-item input[type="checkbox"]:checked+label,
        .year-item input:checked+label {
            color: var(--accent-primary);
            font-weight: 600;
        }

        /* Smooth Transitions - UNIFIED */
        .filter-item,
        .year-item,
        .filter-item-icon,
        .alphabet-btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Improved Visual Hierarchy */
        .countries-grid .filter-item:nth-child(odd) {
            background: rgba(59, 130, 246, 0.02);
        }

        #seriesList .filter-item:nth-child(odd) {
            background: rgba(16, 185, 129, 0.02);
        }

        .year-item:nth-child(odd) {
            background: rgba(245, 158, 11, 0.02);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* Footer */
        .simple-footer {
            background: var(--bg-secondary);
            border-top: 2px solid var(--border-color);
            margin-top: 50px;
            margin-left: 540px;
            padding: 30px 0;
            position: relative;
        }

        .simple-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary), var(--accent-primary));
        }

        .simple-footer .footer-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .simple-footer .footer-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .simple-footer .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            margin-left: 25px;
        }

        .simple-footer .logo-text span {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .simple-footer .footer-info {
            text-align: right;
            color: var(--text-secondary);
        }

        .simple-footer .footer-info p {
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .simple-footer .footer-info strong {
            color: var(--text-primary);
        }

        .simple-footer .copyright {
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
        }

        /* Responsive Styles */
        @media (max-width: 1024px) {
            .header-search {
                max-width: 300px;
                margin: 0 20px;
            }

            .header-controls {
                gap: 15px;
            }

            .social-links {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: static;
                width: 100%;
                height: auto;
                box-shadow: none;
                top: auto;
            }

            .container {
                margin-top: 70px;
                flex-direction: column;
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .simple-footer {
                margin-left: 0;
            }

            .header-container {
                height: 70px;
                padding: 0 15px;
            }

            .header-logo .logo-text h1 {
                font-size: 1.4rem;
            }

            .header-search {
                display: none;
            }

            .lang-dropdown {
                right: -20px;
            }

            .selection-tags {
                grid-template-columns: 1fr;
            }

            .results-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .results-table th,
            .results-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }

            .preview-panel {
                padding: 30px 20px;
            }

            .preview-icon {
                font-size: 3.5rem;
            }

            .preview-panel h2 {
                font-size: 1.6rem;
            }

            .controls-header,
            .chart-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .view-toggles {
                justify-content: center;
            }

            .chart-controls-row {
                flex-wrap: wrap;
                justify-content: center;
            }

            .metadata-grid {
                grid-template-columns: 1fr;
            }

            .chart-content {
                height: 300px;
                padding: 15px;
            }

            .simple-footer .footer-content {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .simple-footer .footer-info {
                text-align: center;
            }

            .simple-footer .footer-info p {
                font-size: 0.85rem;
            }

            .selector-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }

            .selector-controls {
                justify-content: center;
            }

            .country-select {
                min-width: 150px;
            }

            .country-card {
                flex-direction: column;
                text-align: center;
                gap: 12px;
            }

            .country-metrics {
                flex-direction: row;
                justify-content: space-around;
                width: 100%;
            }

            .metric {
                align-items: center;
            }

            /* Mobile alphabet filter */
            .alphabet-filter {
                padding: 10px;
                gap: 3px;
            }

            .alphabet-btn {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }

            /* Mobile unified grid */
            .countries-grid {
                grid-template-columns: 1fr;
            }

            .countries-grid .filter-item {
                padding: 8px 10px;
            }

            /* Mobile series items */
            #seriesList .filter-item {
                padding: 8px 10px;
                margin: 0 4px 2px 4px;
            }

            #seriesList .filter-item-icon {
                width: 16px;
                height: 16px;
                font-size: 0.6rem;
                margin-right: 8px;
            }

            #seriesList .filter-item input[type="checkbox"] {
                width: 14px;
                height: 14px;
                margin-right: 8px;
            }

            #seriesList .filter-item label {
                font-size: 0.85rem;
            }

            /* Mobile years grid */
            .years-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
                gap: 6px;
                padding: 10px;
            }

            .year-item {
                padding: 6px 10px;
                min-height: 36px;
            }

            .year-item input {
                width: 14px;
                height: 14px;
                margin-left: 20px;
            }

            .year-item label {
                font-size: 0.85rem;
            }

            .year-item::before {
                width: 16px;
                height: 16px;
                font-size: 0.7rem;
                left: 6px;
            }

            /* Mobile trade direction grid */
            .trade-direction-grid {
                grid-template-columns: 1fr;
                gap: 6px;
                padding: 10px;
            }

            .trade-direction-item {
                padding: 10px 12px;
                min-height: 44px;
            }

            .trade-direction-item input {
                width: 16px;
                height: 16px;
                margin-left: 30px;
            }

            .trade-direction-item label {
                font-size: 0.85rem;
            }

            .trade-direction-item::before {
                width: 20px;
                height: 20px;
                font-size: 0.8rem;
                left: 8px;
            }
        }

        @media (max-width: 480px) {
            .header-controls {
                gap: 10px;
            }

            .lang-current {
                padding: 8px 12px;
            }

            .toggle-switch {
                width: 50px;
                height: 25px;
            }

            .toggle-switch::before {
                width: 19px;
                height: 19px;
                top: 3px;
                left: 3px;
            }

            .toggle-switch.active::before {
                transform: translateX(25px);
            }

            .view-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .chart-select {
                min-width: 120px;
                font-size: 0.85rem;
            }

            .metadata-card {
                padding: 15px;
                gap: 12px;
            }

            .metadata-icon {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }

            .country-selector-section {
                padding: 15px;
            }

            .country-select {
                min-width: 140px;
                font-size: 0.85rem;
            }

            .country-flag {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .country-details h5 {
                font-size: 1.1rem;
            }

            .alphabet-filter {
                padding: 8px;
                gap: 2px;
            }

            .alphabet-btn {
                width: 22px;
                height: 22px;
                font-size: 0.7rem;
            }

            /* Extra small screen adjustments */
            .filter-item-icon,
            .countries-grid .filter-item-icon,
            #seriesList .filter-item-icon {
                width: 14px;
                height: 14px;
                font-size: 0.55rem;
                margin-right: 6px;
            }

            .filter-item input[type="checkbox"],
            .countries-grid .filter-item input[type="checkbox"],
            #seriesList .filter-item input[type="checkbox"] {
                width: 12px;
                height: 12px;
                margin-right: 6px;
            }

            .filter-item label,
            .countries-grid .filter-item label,
            #seriesList .filter-item label {
                font-size: 0.8rem;
            }

            .year-item {
                padding: 6px 8px;
                min-height: 32px;
            }

            .year-item input {
                width: 12px;
                height: 12px;
                margin-left: 18px;
            }

            .year-item label {
                font-size: 0.8rem;
            }

            .year-item::before {
                width: 14px;
                height: 14px;
                font-size: 0.6rem;
                left: 4px;
            }

            .trade-direction-item {
                padding: 8px 10px;
                min-height: 38px;
            }

            .trade-direction-item input {
                width: 14px;
                height: 14px;
                margin-left: 26px;
            }

            .trade-direction-item label {
                font-size: 0.8rem;
            }

            .trade-direction-item::before {
                width: 18px;
                height: 18px;
                font-size: 0.7rem;
                left: 6px;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-container">
            <!-- Logo Section -->
            <div class="header-logo">
                <div class="logo-icon">
                    <a href="/">
                        <img src="static/images/screen.png" alt="IFMR Logo">
                    </a>
                </div>
                <div class="logo-text">
                    <!-- <h1>IMRS</h1>
                    <span>Ma'lumotlarni boshqarish tizimi</span> -->
                </div>
            </div>

            <!-- Search Section -->
            <div class="header-search">
                <div class="search-container">
                    <i class="fas fa-search"></i>
                    <input type="text" placeholder="Ma'lumotlarni qidirish..." id="headerSearch">
                    <!-- <button class="search-btn" onclick="performHeaderSearch()">
                        <i class="fas fa-arrow-right"></i>
                    </button> -->
                </div>
            </div>

            <!-- Header Controls -->
            <div class="header-controls">
                <!-- Language Selector -->
                <div class="language-selector">
                    <div class="lang-current" onclick="toggleLanguageDropdown()">
                        <img src="https://flagcdn.com/w20/uz.png" alt="UZ" />
                        <span>UZ</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="lang-dropdown" id="langDropdown">
                        <div class="lang-option" onclick="changeLanguage('uz')">
                            <img src="https://flagcdn.com/w20/uz.png" alt="UZ" />
                            <span>O'zbekcha</span>
                        </div>
                        <div class="lang-option" onclick="changeLanguage('ru')">
                            <img src="https://flagcdn.com/w20/ru.png" alt="RU" />
                            <span>Русский</span>
                        </div>
                        <div class="lang-option" onclick="changeLanguage('en')">
                            <img src="https://flagcdn.com/w20/gb.png" alt="EN" />
                            <span>English</span>
                        </div>
                    </div>
                </div>

                <!-- Dark Mode Toggle -->
                <div class="theme-toggle">
                    <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()">
                        <div class="toggle-icons">
                            <i class="fas fa-sun"></i>
                            <i class="fas fa-moon"></i>
                        </div>
                    </div>
                </div>

                <!-- Social Media -->
                <div class="social-links">
                    <a href="https://t.me/imri_uz" target="_blank" title="Telegram" class="social-link">
                        <i class="fab fa-telegram"></i>
                    </a>
                    <a href="https://instagram.com/imri_uz" target="_blank" title="Instagram" class="social-link">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="https://facebook.com/imri.uz" target="_blank" title="Facebook" class="social-link">
                        <i class="fab fa-facebook"></i>
                    </a>
                    <a href="https://youtube.com/@imri_uz" target="_blank" title="YouTube" class="social-link">
                        <i class="fab fa-youtube"></i>
                    </a>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Sidebar with Filters -->
        <div class="sidebar">
            <h2><i class="fas fa-filter"></i> IMRS Filterlar</h2>

            <!-- Countries Section -->
            <div class="filter-section">
                <div class="section-header" onclick="toggleSection('countries')">
                    <div class="section-title">
                        <i class="fas fa-globe"></i>
                        <span>Davlatlar</span>
                    </div>
                    <div class="section-stats">
                        Mavjud: <span id="countries-available">0</span> |
                        <span class="selected-count" id="fake">Tanlangan: <span
                                id="countries-selected">0</span></span>
                    </div>
                </div>

                <div class="section-content" id="countries-content">
                    <div class="filter-controls">
                        <div class="controls-row">
                            <input type="text" class="search-input" placeholder="Davlatlarni qidirish..."
                                id="countrySearch">
                            <button class="control-btn" onclick="selectAllCountries()" title="Barchasini tanlash">
                                <i class="fas fa-check-square"></i>
                            </button>
                            <button class="control-btn" onclick="clearAllCountries()" title="Tozalash">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Alphabet Filter -->
                    <div class="alphabet-filter" id="alphabetFilter">
                        <!-- Alphabet buttons will be generated here -->
                    </div>

                    <div class="items-list">
                        <div class="countries-grid" id="countriesList">
                            <div class="loading" style="grid-column: 1 / -1; text-align: center;">
                                <div class="spinner"></div>
                                <p>Davlatlar yuklanmoqda...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Series/Products Section -->
            <div class="filter-section">
                <div class="section-header" onclick="toggleSection('series')">
                    <div class="section-title">
                        <i class="fas fa-boxes"></i>
                        <span>Mahsulotlar</span>
                    </div>
                    <div class="section-stats">
                        Mavjud: <span id="series-available">0</span> |
                        <span class="selected-count">Tanlangan: <span id="series-selected">0</span></span>
                    </div>
                </div>

                <div class="section-content collapsed" id="series-content">
                    <div class="filter-controls">
                        <div class="controls-row">
                            <!-- <div class="enhanced-search"> -->
                            <input type="text" class="search-input"
                                placeholder="Mahsulot nomi, HS kodi bo'yicha qidirish..." id="seriesSearch"
                                oninput="performEnhancedSearch(this)">
                            <!-- Bu dropdown endi ishlatilmaydi, lekin qoldirib qo'yish mumkin -->
                            <div class="search-dropdown" id="seriesSearchDropdown" style="display: none;">

                            </div>
                            <!-- </div> -->
                            <button class="control-btn" onclick="selectAllSeries()" title="Barchasini tanlash">
                                <i class="fas fa-check-square"></i>
                            </button>
                            <button class="control-btn" onclick="clearAllSeries()" title="Tozalash">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="items-list" id="seriesList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Mahsulotlar yuklanmoqda...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trade Direction Section -->
            <div class="filter-section">
                <div class="section-header" onclick="toggleSection('trade-direction')">
                    <div class="section-title">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Savdo yo'nalishi</span>
                    </div>
                    <div class="section-stats">
                        <span class="selected-count">Tanlangan: <span id="trade-direction-selected">0</span></span>
                    </div>
                </div>

                <div class="section-content collapsed" id="trade-direction-content">
                    <div class="filter-controls">
                        <div class="controls-row">
                            <button class="control-btn" onclick="selectAllTradeDirection()"
                                title="Barchasini tanlash">
                                <i class="fas fa-check-square"></i>
                            </button>
                            <button class="control-btn" onclick="clearAllTradeDirection()" title="Tozalash">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="trade-direction-grid" id="tradeDirectionGrid">
                        <div class="trade-direction-item" data-type="export">
                            <input type="checkbox" id="trade_export" value="export"
                                onchange="updateTradeDirectionSelection()">
                            <label for="trade_export">Eksport</label>
                        </div>
                        <div class="trade-direction-item" data-type="import">
                            <input type="checkbox" id="trade_import" value="import"
                                onchange="updateTradeDirectionSelection()">
                            <label for="trade_import">Import</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Years Section -->
            <div class="filter-section">
                <div class="section-header" onclick="toggleSection('years')">
                    <div class="section-title">
                        <i class="fas fa-calendar"></i>
                        <span>Yillar</span>
                    </div>
                    <div class="section-stats">
                        <span class="selected-count">Tanlangan: <span id="years-selected">0</span></span>
                    </div>
                </div>

                <div class="section-content collapsed" id="years-content">
                    <div class="filter-controls">
                        <div class="controls-row">
                            <button class="control-btn" onclick="selectAllYears()" title="Barchasini tanlash">
                                <i class="fas fa-check-square"></i>
                            </button>
                            <button class="control-btn" onclick="clearAllYears()" title="Tozalash">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="years-grid" id="yearsGrid">
                        <!-- Years will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Preview Panel -->
            <div class="preview-panel" id="previewPanel">
                <div class="preview-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h2>Ma'lumotlarni Filtrlash</h2>
                <p>Quyidagi bo'limlardan kamida bittasini tanlang va "Qidirish" tugmasini bosing.</p>

                <div class="requirements">
                    <div class="requirement" id="countries-requirement">
                        <i class="fas fa-circle"></i>
                        <span>Davlatlar tanlang</span>
                    </div>
                    <div class="requirement" id="series-requirement">
                        <i class="fas fa-circle"></i>
                        <span>Mahsulotlar tanlang</span>
                    </div>
                    <div class="requirement" id="trade-direction-requirement">
                        <i class="fas fa-circle"></i>
                        <span>Savdo yo'nalishini tanlang</span>
                    </div>
                    <div class="requirement" id="years-requirement">
                        <i class="fas fa-circle"></i>
                        <span>Yillar tanlang</span>
                    </div>
                </div>

                <button class="apply-btn" onclick="applyFilters()" id="applyBtn" disabled>
                    <i class="fas fa-search"></i> Qidirish
                </button>
            </div>

            <!-- Results Panel -->
            <div class="results-panel" id="resultsPanel">
                <div class="results-header">
                    <h3>
                        <i class="fas fa-table"></i>
                        Natijalar
                        <span class="results-count" id="resultsCount"></span>
                    </h3>
                    <div class="header-buttons">
                        <button class="control-btn" onclick="showExportOptions()">
                            <i class="fas fa-download"></i> Yuklab olish
                        </button>
                        <button class="control-btn" onclick="showPreview()">
                            <i class="fas fa-arrow-left"></i> Orqaga
                        </button>
                    </div>
                </div>

                <!-- Current Selection Summary -->
                <div class="current-selection-summary" id="currentSelectionSummary">
                    <div class="selection-tags">
                        <div class="selection-tag-group">
                            <strong>🌍 Tanlangan Davlatlar:</strong>
                            <span id="selectedCountriesSummary">Tanlanmagan</span>
                        </div>
                        <div class="selection-tag-group">
                            <strong>📦 Tanlangan Mahsulotlar:</strong>
                            <span id="selectedSeriesSummary">Tanlanmagan</span>
                        </div>
                        <div class="selection-tag-group">
                            <strong>🔄 Savdo yo'nalishi:</strong>
                            <span id="selectedTradeDirectionSummary">Tanlanmagan</span>
                        </div>
                        <div class="selection-tag-group">
                            <strong>📅 Tanlangan Yillar:</strong>
                            <span id="selectedYearsSummary">Tanlanmagan</span>
                        </div>
                    </div>

                    <!-- New Search Button -->
                    <div class="new-search-section">
                        <button class="apply-btn" onclick="applyFilters()" id="newSearchBtn">
                            <i class="fas fa-search"></i> Yangi Qidiruv
                        </button>
                        <p class="new-search-hint">Chapda filtrlarni o'zgartirib, yangi qidiruv amalga oshiring</p>
                    </div>
                </div>

                <!-- Chart Controls -->
                <div class="chart-controls" id="chartControls" style="display: none;">
                    <div class="controls-header">
                        <h4><i class="fas fa-chart-bar"></i> Ma'lumotlar ko'rinishi</h4>
                        <div class="view-toggles">
                            <button class="view-btn active" onclick="showView('table')" id="tableViewBtn">
                                <i class="fas fa-table"></i> Table
                            </button>
                            <button class="view-btn" onclick="showView('chart')" id="chartViewBtn">
                                <i class="fas fa-chart-bar"></i> Chart
                            </button>
                            <button class="view-btn" onclick="showView('metadata')" id="metadataViewBtn">
                                <i class="fas fa-info-circle"></i> Metadata
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Country Selector for Chart and Metadata -->
                <div class="country-selector-section" id="countrySelectorSection" style="display: none;">
                    <div class="selector-header">
                        <h4><i class="fas fa-globe-americas"></i> Davlatni tanlang</h4>
                        <div class="selector-controls">
                            <select class="country-select" id="countrySelector" onchange="updateViewByCountry()">
                                <option value="all">Barcha davlatlar</option>
                                <!-- Dynamic options will be added here -->
                            </select>
                            <button class="control-btn" onclick="resetCountryView()" title="Barchasini ko'rsatish">
                                <i class="fas fa-globe"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Selected Country Info -->
                    <div class="selected-country-info" id="selectedCountryInfo" style="display: none;">
                        <div class="country-card">
                            <div class="country-flag">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="country-details">
                                <h5 id="selectedCountryName">-</h5>
                                <p id="selectedCountryStats">Ma'lumot yuklanmoqda...</p>
                            </div>
                            <div class="country-metrics">
                                <div class="metric">
                                    <span class="metric-label">Yozuvlar:</span>
                                    <span class="metric-value" id="countryRecords">0</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Eksport:</span>
                                    <span class="metric-value" id="countryExport">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table View -->
                <div id="resultsContent">
                    <table class="results-table" id="resultsTable">
                        <thead>
                            <tr>
                                <th><i class="fas fa-globe"></i> Davlat</th>
                                <th><i class="fas fa-box"></i> Mahsulot</th>
                                <th><i class="fas fa-barcode"></i> HS Kod</th>
                                <th><i class="fas fa-calendar"></i> Yil</th>
                                <th><i class="fas fa-exchange-alt"></i> Yo'nalish</th>
                                <th><i class="fas fa-balance-scale"></i> O'lchov</th>
                                <th><i class="fas fa-arrow-up"></i> Eksport Hajmi</th>
                                <th><i class="fas fa-dollar-sign"></i> Eksport Narxi</th>
                                <th><i class="fas fa-arrow-down"></i> Import Hajmi</th>
                                <th><i class="fas fa-dollar-sign"></i> Import Narxi</th>
                                <th><i class="fas fa-layer-group"></i> HS Gruppa</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Chart Container -->
                <div class="chart-container" id="chartContainer" style="display: none;">
                    <div class="chart-header">
                        <h4><i class="fas fa-chart-line"></i> Grafik Tahlil</h4>
                        <div class="chart-controls-row">
                            <select class="chart-select" id="chartType" onchange="updateChart()">
                                <option value="bar">Bar Chart</option>
                                <option value="line">Line Chart</option>
                            </select>
                            <select class="chart-select" id="chartMetric" onchange="updateChart()">
                                <option value="export_volume">Eksport Hajmi</option>
                                <option value="export_price">Eksport Narxi</option>
                                <option value="import_volume">Import Hajmi</option>
                                <option value="import_price">Import Narxi</option>
                            </select>
                            <button class="control-btn" onclick="exportChart()">
                                <i class="fas fa-download"></i> PNG
                            </button>
                        </div>
                    </div>
                    <div class="chart-content">
                        <canvas id="dataChart"></canvas>
                    </div>
                </div>

                <!-- Metadata Container -->
                <div class="metadata-container" id="metadataContainer" style="display: none;">
                    <div class="metadata-header">
                        <h4><i class="fas fa-database"></i> Ma'lumotlar Metadata</h4>
                    </div>

                    <div class="metadata-section-selector">
                        <div class="section-info">
                            <p><i class="fas fa-info-circle"></i>
                                <strong id="metadataCurrentView">Barcha davlatlar</strong> bo'yicha ma'lumotlar
                                ko'rsatilmoqda
                            </p>
                        </div>
                    </div>

                    <div class="metadata-grid">
                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-calculator"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Umumiy ma'lumotlar</h5>
                                <p id="totalRecords">0 ta yozuv</p>
                            </div>
                        </div>

                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-globe"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Davlatlar soni</h5>
                                <p id="uniqueCountries">0 ta davlat</p>
                            </div>
                        </div>

                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Mahsulotlar soni</h5>
                                <p id="uniqueProducts">0 ta mahsulot</p>
                            </div>
                        </div>

                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Yillar oralig'i</h5>
                                <p id="yearRange">-</p>
                            </div>
                        </div>

                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-arrow-up text-success"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Umumiy eksport</h5>
                                <p id="totalExport">0</p>
                            </div>
                        </div>

                        <div class="metadata-card">
                            <div class="metadata-icon">
                                <i class="fas fa-arrow-down text-error"></i>
                            </div>
                            <div class="metadata-info">
                                <h5>Umumiy import</h5>
                                <p id="totalImport">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Detailed Statistics -->
                    <div class="detailed-stats">
                        <h5><i class="fas fa-chart-pie"></i> Davlatlar bo'yicha taqsimot</h5>
                        <div class="stats-table" id="countryStats">
                            <!-- Dynamic content -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Footer -->
    <footer class="simple-footer">
        <div class="footer-content">
            <div class="footer-logo">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="logo-text">
                    <span>IMRS - Tashqi Savdo Tahlili</span>
                </div>
            </div>
            <div class="footer-info">
                <p>O'zbekiston Respublikasi Vazirlar Mahkamasi huzuridagi</p>
                <p><strong>Makroiqtisodiy va xududiy tahlil instituti</strong></p>
                <div class="copyright">
                    &copy; 2024 IMRS. Barcha huquqlar himoyalangan.
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Global variables
        let selectedCountries = [];
        let selectedSeries = [];
        let selectedYears = [];
        let selectedTradeDirections = [];
        let currentLanguage = 'uz';
        let currentChart = null;
        let currentData = [];
        let availableCountries = [];
        let selectedCountryForView = 'all';
        let countryFilteredData = [];
        let activeAlphabetFilter = null;
        let allCountriesData = [];
        let allSeriesData = [];

        const translations = {
            uz: {
                title: 'IMRS Filterlar',
                countries: 'Davlatlar',
                products: 'Mahsulotlar',
                tradeDirection: 'Savdo yo\'nalishi',
                years: 'Yillar',
                search: 'Qidirish',
                searchPlaceholder: 'Ma\'lumotlarni qidirish...'
            },
            ru: {
                title: 'ИМРС Фильтры',
                countries: 'Страны',
                products: 'Продукты',
                tradeDirection: 'Направление торговли',
                years: 'Годы',
                search: 'Поиск',
                searchPlaceholder: 'Поиск данных...'
            },
            en: {
                title: 'IMRS Filters',
                countries: 'Countries',
                products: 'Products',
                tradeDirection: 'Trade Direction',
                years: 'Years',
                search: 'Search',
                searchPlaceholder: 'Search data...'
            }
        };

        // Enhanced Search Function - faqat hs_10_code bo'yicha qidirish
        function performEnhancedSearch(inputElement) {
            const searchTerm = inputElement.value.trim();

            if (searchTerm.length === 0) {
                // Agar qidiruv bo'sh bo'lsa, barcha mahsulotlarni ko'rsat
                displayAllSeries();
                return;
            }

            // Faqat hs_10_code bo'yicha qidirish
            const filteredResults = allSeriesData.filter(item => {
                const hs10String = item.hs_10_code ? String(item.hs_10_code) : '';

                return hs10String.includes(searchTerm);
            });

            console.log('Qidiruv:', searchTerm);
            console.log('Jami ma\'lumotlar:', allSeriesData.length);
            console.log('Topilgan natijalar:', filteredResults.length);

            if (filteredResults.length > 0) {
                console.log('Birinchi natija:', filteredResults[0]);
            } else {
                console.log('Hech narsa topilmadi');
                // Debug uchun birinchi 3 ta elementning hs_10_code larini ko'rsatish
                console.log('Debug - birinchi 3 ta elementning hs_10_code:',
                    allSeriesData.slice(0, 3).map(item => ({
                        name: item.name || item.product_name,
                        hs_10_code: item.hs_10_code
                    }))
                );
            }

            // Natijalarni to'g'ridan-to'g'ri seriesList da ko'rsat
            displayFilteredSeries(filteredResults);
        }

        function displaySearchResults(results, searchTerm) {
            const dropdown = document.getElementById('seriesSearchDropdown');

            if (results.length === 0) {
                dropdown.innerHTML =
                    '<div class="search-result-item"><div class="search-result-title">Natija topilmadi</div></div>';
                return;
            }

            let html = '';
            const limitedResults = results.slice(0, 10); // Show max 10 results

            limitedResults.forEach((item, index) => {
                const name = item.name || item.product_name || 'Noma\'lum mahsulot';
                const shortName = name.length > 50 ? name.substring(0, 47) + '...' : name;

                html += `
                    <div class="search-result-item" onclick="selectFromSearch('${item.name || item.product_name}', '${searchTerm}')">
                        <div class="search-result-title">${shortName}</div>
                        <div class="search-result-meta">
                            ${item.hs_2_code ? `<span><i class="fas fa-barcode"></i> HS2: ${item.hs_2_code}</span>` : ''}
                            ${item.hs_4_code ? `<span><i class="fas fa-barcode"></i> HS4: ${item.hs_4_code}</span>` : ''}
                            ${item.hs_6_code ? `<span><i class="fas fa-barcode"></i> HS6: ${item.hs_6_code}</span>` : ''}
                            ${item.hs_10_code ? `<span><i class="fas fa-barcode"></i> HS10: ${item.hs_10_code}</span>` : ''}
                        </div>
                    </div>
                `;
            });

            if (results.length > 10) {
                html += `<div class="search-result-item" style="color: var(--text-muted); font-style: italic;">
                    Va yana ${results.length - 10} ta natija...
                </div>`;
            }

            dropdown.innerHTML = html;
        }

        function selectFromSearch(productName, searchTerm) {
            // Find and check the corresponding checkbox
            const checkboxes = document.querySelectorAll('#seriesList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.value === productName) {
                    checkbox.checked = true;
                }
            });

            // Update selection
            updateSeriesSelection();

            // Clear search
            document.getElementById('seriesSearch').value = '';
            document.getElementById('seriesSearchDropdown').classList.remove('show');
            displayAllSeries();

            showToast('✅ Tanlandi', `"${productName.substring(0, 30)}..." qo'shildi`, 'success');
        }

        function displayFilteredSeries(filteredSeries) {
            const seriesList = document.getElementById('seriesList');

            if (filteredSeries.length === 0) {
                seriesList.innerHTML = '<div class="no-data">Qidiruv bo\'yicha natija topilmadi</div>';
                return;
            }

            let html = '';
            filteredSeries.forEach((item, index) => {
                const productName = item.name || item.product_name || 'Noma\'lum mahsulot';
                const shortName = productName.length > 100 ? productName.substring(0, 70) + '...' : productName;
                const isSelected = selectedSeries.includes(productName);

                html += `
                    <div class="filter-item">
                        <div class="filter-item-icon">!</div>
                        <input type="checkbox" id="series_filtered_${index}" 
                               value="${productName}" 
                               onchange="updateSeriesSelection()"
                               ${isSelected ? 'checked' : ''}>
                        <label for="series_filtered_${index}" title="${productName}">
                            ${shortName}
                            ${item.hs_6_code ? `<br><small style="color: var(--text-muted);">HS: ${item.hs_6_code}</small>` : ''}
                        </label>
                    </div>
                `;
            });

            seriesList.innerHTML = html;
        }

        function displayAllSeries() {
            displayFilteredSeries(allSeriesData);
        }

        // Close dropdown when clicking outside - bu kod endi kerak emas chunki dropdown yo'q
        // document.addEventListener('click', function(e) {
        //     const dropdown = document.getElementById('seriesSearchDropdown');
        //     const searchInput = document.getElementById('seriesSearch');
        //     if (!e.target.closest('.enhanced-search')) {
        //         dropdown.classList.remove('show');
        //     }
        // });

        // Trade Direction Functions
        function updateTradeDirectionSelection() {
            selectedTradeDirections = Array.from(document.querySelectorAll('input[id^="trade_"]:checked'))
                .map(cb => cb.value);

            document.getElementById('trade-direction-selected').textContent = selectedTradeDirections.length;
            updateRequirements();

            // DEBUG qo'shish
            console.log('🔄 Trade directions updated:', selectedTradeDirections);
            console.log('🔄 Checkbox states:', {
                export: document.getElementById('trade_export')?.checked,
                import: document.getElementById('trade_import')?.checked
            });
        }

        function selectAllTradeDirection() {
            document.querySelectorAll('input[id^="trade_"]').forEach(cb => cb.checked = true);
            updateTradeDirectionSelection();
        }

        function clearAllTradeDirection() {
            document.querySelectorAll('input[id^="trade_"]').forEach(cb => cb.checked = false);
            updateTradeDirectionSelection();
        }

        // Populate countries with new features
        function populateCountries(countries) {
            allCountriesData = countries.sort(); // Store and sort countries
            const countriesList = document.getElementById('countriesList');
            const countriesAvailable = document.getElementById('countries-available');

            countriesAvailable.textContent = countries.length;

            // Generate alphabet filter
            generateAlphabetFilter(countries);

            // Display all countries initially
            displayCountries(countries);

            console.log(`✅ ${countries.length} davlat yuklandi`);
        }

        // Generate alphabet filter
        function generateAlphabetFilter(countries) {
            const alphabetFilter = document.getElementById('alphabetFilter');
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

            // Get available first letters from countries
            const availableLetters = new Set();
            countries.forEach(country => {
                const firstLetter = country.charAt(0).toUpperCase();
                if (alphabet.includes(firstLetter)) {
                    availableLetters.add(firstLetter);
                }
            });

            let html = '';

            // Add "All" button
            html +=
                '<button class="alphabet-btn active" onclick="filterByAlphabet(null)" title="Barcha davlatlar">All</button>';

            alphabet.forEach(letter => {
                const isAvailable = availableLetters.has(letter);
                const className = isAvailable ? 'alphabet-btn' : 'alphabet-btn disabled';
                if (isAvailable) {
                    html +=
                        `<button class="${className}" onclick="filterByAlphabet('${letter}')" title="${letter} harfi bilan boshlanadigan davlatlar">${letter}</button>`;
                } else {
                    html += `<button class="${className}" title="Bu harf bilan davlat yo'q">${letter}</button>`;
                }
            });

            alphabetFilter.innerHTML = html;
        }

        // Filter countries by alphabet
        function filterByAlphabet(letter) {
            activeAlphabetFilter = letter;

            // Update active button
            document.querySelectorAll('.alphabet-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            if (letter === null) {
                document.querySelector('.alphabet-btn[onclick="filterByAlphabet(null)"]').classList.add('active');
                displayCountries(allCountriesData);
            } else {
                document.querySelector(`.alphabet-btn[onclick="filterByAlphabet('${letter}')"]`).classList.add('active');
                const filteredCountries = allCountriesData.filter(country =>
                    country.charAt(0).toUpperCase() === letter
                );
                displayCountries(filteredCountries);
            }

            // Clear search when using alphabet filter
            document.getElementById('countrySearch').value = '';
        }

        // Display countries in grid
        function displayCountries(countries) {
            const countriesList = document.getElementById('countriesList');

            if (countries.length === 0) {
                countriesList.innerHTML =
                    '<div style="grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 20px;">Ma\'lumot topilmadi</div>';
                return;
            }

            let html = '';
            countries.forEach((country, index) => {
                const countryId = `country_${allCountriesData.indexOf(country)}`;
                const firstLetter = country.charAt(0).toUpperCase();

                html += `
           <div class="filter-item">
               <div class="filter-item-icon">!</div>
               <input type="checkbox" id="${countryId}" 
                      value="${country}" 
                      onchange="updateCountriesSelection()"
                      ${selectedCountries.includes(country) ? 'checked' : ''}>
               <label for="${countryId}" title="${country}">${country}</label>
           </div>
       `;
            });

            countriesList.innerHTML = html;
        }

        // Update country search functionality
        function initializeCountrySearch() {
            const countrySearch = document.getElementById('countrySearch');
            if (countrySearch) {
                countrySearch.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase();

                    if (searchTerm === '') {
                        // If search is empty, show current alphabet filter
                        if (activeAlphabetFilter) {
                            filterByAlphabet(activeAlphabetFilter);
                        } else {
                            displayCountries(allCountriesData);
                        }
                    } else {
                        // Reset alphabet filter when searching
                        activeAlphabetFilter = null;
                        document.querySelectorAll('.alphabet-btn').forEach(btn => {
                            btn.classList.remove('active');
                        });

                        // Filter countries by search term
                        const filteredCountries = allCountriesData.filter(country =>
                            country.toLowerCase().includes(searchTerm)
                        );
                        displayCountries(filteredCountries);
                    }
                });
            }
        }

        // Update selections
        function updateCountriesSelection() {
            selectedCountries = Array.from(document.querySelectorAll('#countriesList input[type="checkbox"]:checked'))
                .map(cb => cb.value);

            document.getElementById('countries-selected').textContent = selectedCountries.length;
            updateRequirements();

            console.log('🌍 Countries selected:', selectedCountries.length);
        }

        // Populate series/products with enhanced data structure
        function populateSeries(series) {
            // Enhanced series data structure to support HS codes
            allSeriesData = series.map((item, index) => {
                if (typeof item === 'string') {
                    return {
                        name: item,
                        product_name: item,
                        hs_2_code: null,
                        hs_4_code: null,
                        hs_6_code: null,
                        hs_10_code: null
                    };
                }
                return item;
            });

            const seriesAvailable = document.getElementById('series-available');
            seriesAvailable.textContent = allSeriesData.length;

            displayAllSeries();
            console.log(`✅ ${allSeriesData.length} mahsulot yuklandi`);
        }

        // Load filter data from database
        async function loadFilterData() {
            try {
                console.log('📋 Loading filter data from database...');

                const response = await fetch('/api/filter-options');

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('📋 Database data received:', data);

                if (data.success !== false && data.countries && data.products) {
                    console.log(`✅ Real data: ${data.countries.length} countries, ${data.products.length} products`);

                    populateCountries(data.countries);
                    populateSeries(data.products);

                    // Agar pagination ma'lumoti bo'lsa, to'g'ri sonni ko'rsat
                    if (data.pagination && data.pagination.total) {
                        document.getElementById('series-available').textContent = data.pagination.total;
                        console.log(`📊 Total products in database: ${data.pagination.total}`);
                    }

                    if (data.years) {
                        generateYearsFromDB(data.years);
                    } else {
                        generateYears();
                    }

                    showToast('✅ Ma\'lumotlar yuklandi!',
                        `${data.countries.length} davlat, ${data.products.length} mahsulot ko'rsatildi`, 'success');
                } else {
                    throw new Error('Invalid data format from API');
                }

            } catch (error) {
                console.error('❌ Database connection failed:', error);
                console.log('📋 Falling back to test data...');

                populateCountries([
                    'Germany', 'Russian Federation', 'Kazakhstan', 'China', 'USA', 'Turkey',
                    'Uzbekistan', 'France', 'Italy', 'Spain', 'Brazil', 'India', 'Japan',
                    'South Korea', 'Netherlands', 'Belgium', 'Poland', 'Czech Republic'
                ]);

                // Enhanced test data with HS codes
                const testSeriesData = [{
                        name: 'Live animals and animal products',
                        hs_2_code: '01',
                        hs_4_code: '0101',
                        hs_6_code: '010110'
                    },
                    {
                        name: 'Vegetable products',
                        hs_2_code: '02',
                        hs_4_code: '0201',
                        hs_6_code: '020110'
                    },
                    {
                        name: 'Animal or vegetable fats and oils',
                        hs_2_code: '15',
                        hs_4_code: '1501',
                        hs_6_code: '150110'
                    },
                    {
                        name: 'Prepared foodstuffs; beverages, spirits and vinegar; tobacco',
                        hs_2_code: '16',
                        hs_4_code: '1601',
                        hs_6_code: '160100'
                    },
                    {
                        name: 'Mineral products',
                        hs_2_code: '25',
                        hs_4_code: '2501',
                        hs_6_code: '250100'
                    },
                    {
                        name: 'Products of the chemical or allied industries',
                        hs_2_code: '28',
                        hs_4_code: '2801',
                        hs_6_code: '280110'
                    },
                    {
                        name: 'Plastics and articles thereof; rubber and articles thereof',
                        hs_2_code: '39',
                        hs_4_code: '3901',
                        hs_6_code: '390110'
                    },
                    {
                        name: 'Raw hides and skins, leather, furskins and articles thereof',
                        hs_2_code: '41',
                        hs_4_code: '4101',
                        hs_6_code: '410110'
                    },
                    {
                        name: 'Wood and articles of wood; wood charcoal; cork and articles of cork',
                        hs_2_code: '44',
                        hs_4_code: '4401',
                        hs_6_code: '440110'
                    },
                    {
                        name: 'Pulp of wood or of other fibrous cellulosic material',
                        hs_2_code: '47',
                        hs_4_code: '4701',
                        hs_6_code: '470110'
                    },
                    {
                        name: 'Textiles and textile articles',
                        hs_2_code: '50',
                        hs_4_code: '5001',
                        hs_6_code: '500100'
                    },
                    {
                        name: 'Footwear, headgear, umbrellas, sun umbrellas',
                        hs_2_code: '64',
                        hs_4_code: '6401',
                        hs_6_code: '640110'
                    },
                    {
                        name: 'Articles of stone, plaster, cement, asbestos, mica or similar materials',
                        hs_2_code: '68',
                        hs_4_code: '6801',
                        hs_6_code: '680100'
                    },
                    {
                        name: 'Natural or cultured pearls, precious or semi-precious stones',
                        hs_2_code: '71',
                        hs_4_code: '7101',
                        hs_6_code: '710110'
                    },
                    {
                        name: 'Base metals and articles of base metal',
                        hs_2_code: '72',
                        hs_4_code: '7201',
                        hs_6_code: '720110'
                    },
                    {
                        name: 'Machinery and mechanical appliances; electrical equipment',
                        hs_2_code: '84',
                        hs_4_code: '8401',
                        hs_6_code: '840110'
                    },
                    {
                        name: 'Vehicles, aircraft, vessels and associated transport equipment',
                        hs_2_code: '87',
                        hs_4_code: '8701',
                        hs_6_code: '870110'
                    },
                    {
                        name: 'Optical, photographic, cinematographic, measuring, checking, precision',
                        hs_2_code: '90',
                        hs_4_code: '9001',
                        hs_6_code: '900110'
                    }
                ];

                populateSeries(testSeriesData);
                generateYears();

                showToast('⚠️ Test rejimi', 'Database mavjud emas, test ma\'lumotlari yuklandi', 'info');
            }
        }

        // Generate years from database
        function generateYearsFromDB(years) {
            const yearsGrid = document.getElementById('yearsGrid');

            let html = '';
            years.forEach(year => {
                html += `
                    <div class="year-item">
                        <input type="checkbox" id="year_${year}" 
                               value="${year}" 
                               onchange="updateYearsSelection()">
                        <label for="year_${year}">${year}</label>
                    </div>
                `;
            });

            yearsGrid.innerHTML = html;
            console.log(`✅ ${years.length} yil database dan yuklandi`);
        }

        // Generate years (fallback)
        function generateYears() {
            const yearsGrid = document.getElementById('yearsGrid');
            const currentYear = new Date().getFullYear();

            let html = '';
            for (let i = 0; i < 10; i++) {
                const year = currentYear - i;
                html += `
                    <div class="year-item">
                        <input type="checkbox" id="year_${year}" 
                               value="${year}" 
                               onchange="updateYearsSelection()">
                        <label for="year_${year}">${year}</label>
                    </div>
                `;
            }

            yearsGrid.innerHTML = html;
            console.log('✅ Yillar (fallback) yaratildi');
        }

        // Toggle sections
        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + '-content');
            const isCollapsed = content.classList.contains('collapsed');

            // Close all other sections
            document.querySelectorAll('.section-content').forEach(el => {
                if (el.id !== sectionName + '-content') {
                    el.classList.add('collapsed');
                }
            });

            // Toggle current section
            if (isCollapsed) {
                content.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
            }
        }

        function updateSeriesSelection() {
            selectedSeries = Array.from(document.querySelectorAll('input[id^="series_"]:checked'))
                .map(cb => cb.value);

            document.getElementById('series-selected').textContent = selectedSeries.length;
            updateRequirements();

            console.log('📦 Series selected:', selectedSeries.length);
        }

        function updateYearsSelection() {
            selectedYears = Array.from(document.querySelectorAll('input[id^="year_"]:checked'))
                .map(cb => parseInt(cb.value));

            document.getElementById('years-selected').textContent = selectedYears.length;
            updateRequirements();

            console.log('📅 Years selected:', selectedYears.length);
        }

        // Update requirements display
        function updateRequirements() {
            const countriesReq = document.getElementById('countries-requirement');
            const seriesReq = document.getElementById('series-requirement');
            const tradeDirectionReq = document.getElementById('trade-direction-requirement');
            const yearsReq = document.getElementById('years-requirement');
            const applyBtn = document.getElementById('applyBtn');

            // Countries
            if (selectedCountries.length > 0) {
                countriesReq.classList.add('completed');
                countriesReq.querySelector('i').className = 'fas fa-check-circle';
            } else {
                countriesReq.classList.remove('completed');
                countriesReq.querySelector('i').className = 'fas fa-circle';
            }

            // Series
            if (selectedSeries.length > 0) {
                seriesReq.classList.add('completed');
                seriesReq.querySelector('i').className = 'fas fa-check-circle';
            } else {
                seriesReq.classList.remove('completed');
                seriesReq.querySelector('i').className = 'fas fa-circle';
            }

            // Trade Direction
            if (selectedTradeDirections.length > 0) {
                tradeDirectionReq.classList.add('completed');
                tradeDirectionReq.querySelector('i').className = 'fas fa-check-circle';
            } else {
                tradeDirectionReq.classList.remove('completed');
                tradeDirectionReq.querySelector('i').className = 'fas fa-circle';
            }

            // Years
            if (selectedYears.length > 0) {
                yearsReq.classList.add('completed');
                yearsReq.querySelector('i').className = 'fas fa-check-circle';
            } else {
                yearsReq.classList.remove('completed');
                yearsReq.querySelector('i').className = 'fas fa-circle';
            }

            // Enable/disable apply button
            const hasSelections = selectedCountries.length > 0 || selectedSeries.length > 0 || selectedYears.length > 0 ||
                selectedTradeDirections.length > 0;
            applyBtn.disabled = !hasSelections;
        }

        // Select all functions
        function selectAllCountries() {
            document.querySelectorAll('input[id^="country_"]').forEach(cb => cb.checked = true);
            updateCountriesSelection();
        }

        function clearAllCountries() {
            document.querySelectorAll('input[id^="country_"]').forEach(cb => cb.checked = false);
            updateCountriesSelection();
        }

        function selectAllSeries() {
            document.querySelectorAll('input[id^="series_"]').forEach(cb => cb.checked = true);
            updateSeriesSelection();
        }

        function clearAllSeries() {
            document.querySelectorAll('input[id^="series_"]').forEach(cb => cb.checked = false);
            updateSeriesSelection();
        }

        function selectAllYears() {
            document.querySelectorAll('input[id^="year_"]').forEach(cb => cb.checked = true);
            updateYearsSelection();
        }

        function clearAllYears() {
            document.querySelectorAll('input[id^="year_"]').forEach(cb => cb.checked = false);
            updateYearsSelection();
        }

        // Language functions
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('langDropdown');
            dropdown.classList.toggle('show');

            document.addEventListener('click', function closeDropdown(e) {
                if (!e.target.closest('.language-selector')) {
                    dropdown.classList.remove('show');
                    document.removeEventListener('click', closeDropdown);
                }
            });
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('language', lang);

            const langCurrent = document.querySelector('.lang-current');
            const flags = {
                uz: 'https://flagcdn.com/w20/uz.png',
                ru: 'https://flagcdn.com/w20/ru.png',
                en: 'https://flagcdn.com/w20/gb.png'
            };

            langCurrent.innerHTML = `
                <img src="${flags[lang]}" alt="${lang.toUpperCase()}" class="flag-icon">
                <span>${lang.toUpperCase()}</span>
                <i class="fas fa-chevron-down"></i>
            `;

            document.getElementById('langDropdown').classList.remove('show');
            updateInterfaceLanguage();
            showToast('🌐 Til o\'zgartirildi', `Interface ${lang.toUpperCase()} tiliga o\'tkazildi`, 'info');
        }

        function updateInterfaceLanguage() {
            const t = translations[currentLanguage];

            const h2 = document.querySelector('h2');
            if (h2) h2.innerHTML = `<i class="fas fa-filter"></i> ${t.title}`;

            const sections = document.querySelectorAll('.section-title span');
            if (sections[0]) sections[0].textContent = t.countries;
            if (sections[1]) sections[1].textContent = t.products;
            if (sections[2]) sections[2].textContent = t.tradeDirection;
            if (sections[3]) sections[3].textContent = t.years;

            const headerSearch = document.getElementById('headerSearch');
            if (headerSearch) headerSearch.placeholder = t.searchPlaceholder;

            const applyBtn = document.getElementById('applyBtn');
            if (applyBtn) applyBtn.innerHTML = `<i class="fas fa-search"></i> ${t.search}`;

            const newSearchBtn = document.getElementById('newSearchBtn');
            if (newSearchBtn) newSearchBtn.innerHTML = `<i class="fas fa-search"></i> ${t.search}`;
        }

        function performHeaderSearch() {
            const query = document.getElementById('headerSearch').value;
            if (query.trim()) {
                showToast('🔍 Qidiruv', `"${query}" bo\'yicha qidiruv boshlandi`, 'info');
            }
        }

        function initializeLanguage() {
            const savedLanguage = localStorage.getItem('language') || 'uz';
            if (savedLanguage && savedLanguage !== 'uz') {
                changeLanguage(savedLanguage);
            }
        }

        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const toggleSwitch = document.getElementById('themeToggle');
            const currentTheme = html.getAttribute('data-theme');

            if (currentTheme === 'dark') {
                html.removeAttribute('data-theme');
                toggleSwitch.classList.remove('active');
                localStorage.setItem('theme', 'light');
                showToast('🌞 Yorug\'lik rejimi', 'Tema yorug\'lik rejimiga o\'tkazildi', 'info');
            } else {
                html.setAttribute('data-theme', 'dark');
                toggleSwitch.classList.add('active');
                localStorage.setItem('theme', 'dark');
                showToast('🌙 Qorong\'u rejim', 'Tema qorong\'u rejimiga o\'tkazildi', 'info');
            }
        }

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const toggleSwitch = document.getElementById('themeToggle');

            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                toggleSwitch.classList.add('active');
            } else {
                document.documentElement.removeAttribute('data-theme');
                toggleSwitch.classList.remove('active');
            }
        }

        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 IMRS Filter System Loading...');
            initializeTheme();
            initializeLanguage();
            initializeCountrySearch(); // Initialize country search
            loadFilterData();

            // Header search Enter key
            const headerSearch = document.getElementById('headerSearch');
            if (headerSearch) {
                headerSearch.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        performHeaderSearch();
                    }
                });
            }
        });

        // Apply filters with enhanced trade direction support
        async function applyFilters() {
            console.log('🚀 Applying filters to database...');
            console.log('Countries:', selectedCountries);
            console.log('Series:', selectedSeries);
            console.log('Trade Directions:', selectedTradeDirections);
            console.log('Years:', selectedYears);

            const applyBtn = document.getElementById('applyBtn');
            const newSearchBtn = document.getElementById('newSearchBtn');

            // Update both buttons
            [applyBtn, newSearchBtn].forEach(btn => {
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ma\'lumotlar qidirilmoqda...';
                    btn.disabled = true;
                }
            });

            try {
                // Prepare form data for API
                const formData = new FormData();
                selectedCountries.forEach(country => formData.append('countries', country));
                selectedSeries.forEach(series => formData.append('products', series));
                selectedTradeDirections.forEach(direction => formData.append('trade_directions', direction));
                selectedYears.forEach(year => formData.append('years', year));

                // Real API call to get filtered data
                const response = await fetch('/api/get-data', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('📊 Filter results:', result);

                if (result.success && result.data) {
                    // Filter data based on trade directions
                    const filteredData = filterDataByTradeDirection(result.data);

                    // Display filtered results
                    displayRealResults(filteredData);

                    // Update selection summary
                    updateSelectionSummary();

                    // Show results panel
                    document.getElementById('previewPanel').style.display = 'none';
                    document.getElementById('resultsPanel').style.display = 'block';

                    // Update results count
                    document.getElementById('resultsCount').textContent = `(${filteredData.length} ta natija)`;

                    showToast('🎉 Muvaffaqiyat!', `${filteredData.length} ta ma\'lumot topildi`, 'success');
                } else {
                    throw new Error(result.error || 'Ma\'lumot topilmadi');
                }

            } catch (error) {
                console.error('❌ Error applying filters:', error);

                // Show enhanced sample results if API fails
                console.log('📋 Showing enhanced sample results...');
                const sampleData = generateEnhancedSampleResults();
                const filteredData = filterDataByTradeDirection(sampleData);
                displayRealResults(filteredData);

                // Update selection summary
                updateSelectionSummary();

                document.getElementById('previewPanel').style.display = 'none';
                document.getElementById('resultsPanel').style.display = 'block';
                document.getElementById('resultsCount').textContent = '(Test ma\'lumotlari)';

                showToast('⚠️ Test rejimi', 'API ishlamayapti, test natijalar ko\'rsatilmoqda', 'info');
            } finally {
                // Reset both buttons
                [applyBtn, newSearchBtn].forEach(btn => {
                    if (btn) {
                        btn.innerHTML = btn.id === 'applyBtn' ?
                            '<i class="fas fa-search"></i> Qidirish' :
                            '<i class="fas fa-search"></i> Yangi Qidiruv';
                        btn.disabled = false;
                    }
                });
            }
        }

        // Filter data based on selected trade directions - yangilangan versiya
        function filterDataByTradeDirection(data) {
            if (selectedTradeDirections.length === 0) {
                return data; // Hech narsa tanlanmagan bo'lsa, barcha ma'lumotlar
            }

            return data.filter(item => {
                let matchesDirection = false;

                selectedTradeDirections.forEach(direction => {
                    if (direction === 'export' && (item.export_volume > 0 || item.export_price > 0)) {
                        matchesDirection = true;
                        // Import ma'lumotlarini 0 ga o'rnatish
                        item.import_volume = 0;
                        item.import_price = 0;
                    }
                    if (direction === 'import' && (item.import_volume > 0 || item.import_price > 0)) {
                        matchesDirection = true;
                        // Export ma'lumotlarini 0 ga o'rnatish
                        item.export_volume = 0;
                        item.export_price = 0;
                    }
                });

                return matchesDirection;
            });
        }

        // Generate dynamic table headers based on selected trade directions
        function generateTableHeaders() {
            const resultsTable = document.querySelector('.results-table thead tr');
            if (!resultsTable) {
                console.error('Results table header not found');
                return;
            }

            let headers = `
        <th><i class="fas fa-globe"></i> Davlat</th>
        <th><i class="fas fa-box"></i> Mahsulot</th>
        <th><i class="fas fa-barcode"></i> HS Kod</th>
        <th><i class="fas fa-calendar"></i> Yil</th>
        <th><i class="fas fa-exchange-alt"></i> Yo'nalish</th>
        <th><i class="fas fa-balance-scale"></i> O'lchov</th>
    `;

            // Faqat export tanlangan bo'lsa
            if (selectedTradeDirections.length > 0 && selectedTradeDirections.includes('export') && !selectedTradeDirections
                .includes('import')) {
                headers += `
            <th><i class="fas fa-arrow-up"></i> Eksport Hajmi</th>
            <th><i class="fas fa-dollar-sign"></i> Eksport Narxi</th>
        `;
            }
            // Faqat import tanlangan bo'lsa
            else if (selectedTradeDirections.length > 0 && selectedTradeDirections.includes('import') && !
                selectedTradeDirections.includes('export')) {
                headers += `
            <th><i class="fas fa-arrow-down"></i> Import Hajmi</th>
            <th><i class="fas fa-dollar-sign"></i> Import Narxi</th>
        `;
            }
            // Ikkalasi ham tanlangan yoki hech narsa tanlanmagan
            else {
                headers += `
            <th><i class="fas fa-arrow-up"></i> Eksport Hajmi</th>
            <th><i class="fas fa-dollar-sign"></i> Eksport Narxi</th>
            <th><i class="fas fa-arrow-down"></i> Import Hajmi</th>
            <th><i class="fas fa-dollar-sign"></i> Import Narxi</th>
        `;
            }

            headers += `<th><i class="fas fa-layer-group"></i> HS Gruppa</th>`;
            resultsTable.innerHTML = headers;
        }

        // Update chart metric options based on selected trade directions
        function updateChartMetricOptions() {
            const chartMetric = document.getElementById('chartMetric');
            let options = '';

            // Add export options only if export is selected
            if (selectedTradeDirections.length === 0 || selectedTradeDirections.includes('export')) {
                options += `
                    <option value="export_volume">Eksport Hajmi</option>
                    <option value="export_price">Eksport Narxi</option>
                `;
            }

            // Add import options only if import is selected
            if (selectedTradeDirections.length === 0 || selectedTradeDirections.includes('import')) {
                options += `
                    <option value="import_volume">Import Hajmi</option>
                    <option value="import_price">Import Narxi</option>
                `;
            }

            // If no options available, show default message
            if (options === '') {
                options = '<option value="">Savdo yo\'nalishini tanlang</option>';
            }

            chartMetric.innerHTML = options;
        }

        // Display real results from database
        function displayRealResults(data) {
            currentData = data;
            countryFilteredData = data;

            console.log('🔍 displayRealResults called with trade directions:', selectedTradeDirections);
            console.log('📊 Data length:', data.length);

            // AVVAL jadval sarlavhalarini yangilash
            generateTableHeaders();
            updateChartMetricOptions();

            const tbody = document.getElementById('resultsTableBody');
            let html = '';

            if (data.length === 0) {
                const colspan = calculateTableColspan();
                html =
                    `<tr><td colspan="${colspan}" class="no-data">Tanlangan filterlar bo'yicha ma'lumot topilmadi</td></tr>`;
            } else {
                data.forEach(item => {
                    html += generateTableRow(item);
                });
            }

            tbody.innerHTML = html;
            showChartControls();
            showCountrySelector();

            console.log(`✅ ${data.length} filtered results displayed with trade directions:`, selectedTradeDirections);
        }

        // Generate table row based on selected trade directions
        function generateTableRow(item) {
            let row = `
    <tr>
        <td><strong>${item.country || item.trading_partner || '-'}</strong></td>
        <td title="${item.name || item.product_name || '-'}">${truncateText(item.name || item.product_name || '-', 40)}</td>
        <td>${item.code || item.hs_code || item.hs_10_code || '-'}</td>
        <td><span class="year-badge">${item.year || '-'}</span></td>
        <td>
    `;

            // Yo'nalish
            let tradeDirection = '';
            if ((selectedTradeDirections.length === 0 || selectedTradeDirections.includes('export')) &&
                (item.export_volume > 0 || item.export_price > 0)) {
                tradeDirection += '<span style="color: var(--success);">📈 Eksport</span>';
            }
            if ((selectedTradeDirections.length === 0 || selectedTradeDirections.includes('import')) &&
                (item.import_volume > 0 || item.import_price > 0)) {
                if (tradeDirection) tradeDirection += ' / ';
                tradeDirection += '<span style="color: var(--error);">📉 Import</span>';
            }
            if (!tradeDirection) {
                tradeDirection = '-';
            }

            row += `${tradeDirection}</td>`;
            row += `<td><strong>${item.measure || '-'}</strong></td>`;

            // Faqat export tanlangan bo'lsa
            if (selectedTradeDirections.length > 0 && selectedTradeDirections.includes('export') && !selectedTradeDirections
                .includes('import')) {
                row += `
            <td>${formatPrice(item.export_volume || 0)}</td>
            <td>${formatPrice(item.export_price || 0)}</td>
        `;
            }
            // Faqat import tanlangan bo'lsa
            else if (selectedTradeDirections.length > 0 && selectedTradeDirections.includes('import') && !
                selectedTradeDirections.includes('export')) {
                row += `
            <td>${formatPrice(item.import_volume || 0)}</td>
            <td>${formatPrice(item.import_price || 0)}</td>
        `;
            }
            // Ikkalasi ham tanlangan yoki hech narsa tanlanmagan
            else {
                row += `
            <td>${formatPrice(item.export_volume || 0)}</td>
            <td>${formatPrice(item.export_price || 0)}</td>
            <td>${formatPrice(item.import_volume || 0)}</td>
            <td>${formatPrice(item.import_price || 0)}</td>
        `;
            }

            row += `<td title="${item.hs_group || '-'}">${truncateText(item.hs_group || '-', 30)}</td>`;
            row += `</tr>`;
            return row;
        }

        // Calculate table colspan for no-data message
        function calculateTableColspan() {
            let colspan = 6; // Asosiy ustunlar: Country, Product, HS Code, Year, Trade Direction, Measure

            // Faqat export tanlangan bo'lsa
            if (selectedTradeDirections.length > 0 && selectedTradeDirections.includes('export') && !selectedTradeDirections
                .includes('import')) {
                colspan += 2; // Export Volume, Export Price
            }
            // Faqat import tanlangan bo'lsa
            else if (selectedTradeDirections.length > 0 && selectedTradeDirections.includes('import') && !
                selectedTradeDirections.includes('export')) {
                colspan += 2; // Import Volume, Import Price
            }
            // Ikkalasi ham tanlangan yoki hech narsa tanlanmagan
            else {
                colspan += 4; // Export Volume, Export Price, Import Volume, Import Price
            }

            colspan += 1; // HS Group
            return colspan;
        }

        // Generate enhanced sample results with trade direction
        function generateEnhancedSampleResults() {
            const enhancedSampleData = [{
                    country: 'Germany',
                    product: 'Machinery and mechanical appliances',
                    hs_code: '8401',
                    year: 2023,
                    measure: 'kg',
                    export_volume: 15000000,
                    export_price: 45000000,
                    import_volume: 8000000,
                    import_price: 25000000,
                    hs_group: 'Nuclear reactors, boilers, machinery'
                },
                {
                    country: 'China',
                    product: 'Electrical machinery and equipment',
                    hs_code: '8501',
                    year: 2023,
                    measure: 'kg',
                    export_volume: 25000000,
                    export_price: 80000000,
                    import_volume: 12000000,
                    import_price: 35000000,
                    hs_group: 'Electrical machinery and equipment'
                },
                {
                    country: 'Russian Federation',
                    product: 'Mineral fuels, oils and products',
                    hs_code: '2701',
                    year: 2023,
                    measure: 'tons',
                    export_volume: 0,
                    export_price: 0,
                    import_volume: 50000000,
                    import_price: 120000000,
                    hs_group: 'Mineral fuels, mineral oils'
                },
                {
                    country: 'Kazakhstan',
                    product: 'Cereals',
                    hs_code: '1001',
                    year: 2023,
                    measure: 'tons',
                    export_volume: 5000000,
                    export_price: 15000000,
                    import_volume: 0,
                    import_price: 0,
                    hs_group: 'Cereals'
                },
                {
                    country: 'Turkey',
                    product: 'Textiles and textile articles',
                    hs_code: '5208',
                    year: 2023,
                    measure: 'kg',
                    export_volume: 8000000,
                    export_price: 25000000,
                    import_volume: 3000000,
                    import_price: 8000000,
                    hs_group: 'Cotton fabrics'
                },
                {
                    country: 'USA',
                    product: 'Aircraft, spacecraft and parts thereof',
                    hs_code: '8802',
                    year: 2022,
                    measure: 'units',
                    export_volume: 0,
                    export_price: 0,
                    import_volume: 50,
                    import_price: 500000000,
                    hs_group: 'Aircraft, spacecraft'
                },
                {
                    country: 'Italy',
                    product: 'Vehicles other than railway',
                    hs_code: '8703',
                    year: 2022,
                    measure: 'units',
                    export_volume: 1200,
                    export_price: 30000000,
                    import_volume: 800,
                    import_price: 20000000,
                    hs_group: 'Motor cars and vehicles'
                },
                {
                    country: 'France',
                    product: 'Pharmaceutical products',
                    hs_code: '3004',
                    year: 2022,
                    measure: 'kg',
                    export_volume: 500000,
                    export_price: 12000000,
                    import_volume: 1200000,
                    import_price: 35000000,
                    hs_group: 'Medicaments'
                }
            ];

            return enhancedSampleData;
        }

        function updateTableView() {
            // Generate dynamic table headers
            generateTableHeaders();

            const tbody = document.getElementById('resultsTableBody');
            let html = '';

            if (countryFilteredData.length === 0) {
                const colspan = calculateTableColspan();
                html = `<tr><td colspan="${colspan}" class="no-data">Tanlangan davlat uchun ma'lumot topilmadi</td></tr>`;
            } else {
                countryFilteredData.forEach(item => {
                    html += generateTableRow(item);
                });
            }

            tbody.innerHTML = html;

            // Update results count
            const resultsCount = document.getElementById('resultsCount');
            if (selectedCountryForView === 'all') {
                resultsCount.textContent = `(${countryFilteredData.length} ta natija)`;
            } else {
                resultsCount.textContent = `(${selectedCountryForView}: ${countryFilteredData.length} ta natija)`;
            }

            console.log(`Table updated for ${selectedCountryForView}: ${countryFilteredData.length} records`);
        }

        function updateViewByCountry() {
            const selector = document.getElementById('countrySelector');
            selectedCountryForView = selector.value;

            if (selectedCountryForView === 'all') {
                // Show all data
                countryFilteredData = currentData;
                document.getElementById('selectedCountryInfo').style.display = 'none';
            } else {
                // Filter data by selected country
                countryFilteredData = currentData.filter(item =>
                    (item.country || item.trading_partner) === selectedCountryForView
                );

                // Show country info
                showSelectedCountryInfo();
            }

            // Update metadata current view
            updateMetadataCurrentView();

            // Update TABLE VIEW
            updateTableView();

            // Update current view
            const activeView = document.querySelector('.view-btn.active').id.replace('ViewBtn', '');
            if (activeView === 'chart') {
                updateChartWithCountryData();
            } else if (activeView === 'metadata') {
                updateMetadataWithCountryData();
            }

            console.log(`Updated view for: ${selectedCountryForView}, Records: ${countryFilteredData.length}`);
        }

        function showSelectedCountryInfo() {
            const countryInfo = document.getElementById('selectedCountryInfo');
            const countryName = document.getElementById('selectedCountryName');
            const countryStats = document.getElementById('selectedCountryStats');
            const countryRecords = document.getElementById('countryRecords');
            const countryExport = document.getElementById('countryExport');

            // Calculate country statistics
            const totalRecords = countryFilteredData.length;
            const totalExport = countryFilteredData.reduce((sum, item) =>
                sum + (parseFloat(item.export_volume) || 0), 0
            );
            const uniqueProducts = [...new Set(countryFilteredData.map(item =>
                item.name || item.product_name
            ))].filter(Boolean).length;

            // Update display
            countryName.textContent = selectedCountryForView;
            countryStats.textContent = `${uniqueProducts} xil mahsulot bo'yicha ma'lumotlar`;
            countryRecords.textContent = totalRecords.toLocaleString();
            countryExport.textContent = formatNumber(totalExport);

            countryInfo.style.display = 'block';
        }

        function resetCountryView() {
            document.getElementById('countrySelector').value = 'all';
            updateViewByCountry();
            showToast('Barcha davlatlar', 'Barcha davlatlar ma\'lumotlari ko\'rsatilmoqda', 'info');
        }

        function updateMetadataCurrentView() {
            const metadataCurrentView = document.getElementById('metadataCurrentView');
            if (metadataCurrentView) {
                if (selectedCountryForView === 'all') {
                    metadataCurrentView.textContent = 'Barcha davlatlar';
                } else {
                    metadataCurrentView.textContent = selectedCountryForView;
                }
            }
        }

        function showView(viewType) {
            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(viewType + 'ViewBtn').classList.add('active');

            // Hide all containers
            document.getElementById('resultsContent').style.display = viewType === 'table' ? 'block' : 'none';
            document.getElementById('chartContainer').style.display = viewType === 'chart' ? 'block' : 'none';
            document.getElementById('metadataContainer').style.display = viewType === 'metadata' ? 'block' : 'none';

            // Initialize specific view with country filtering
            if (viewType === 'table') {
                updateTableView();
            } else if (viewType === 'chart') {
                updateChartWithCountryData();
            } else if (viewType === 'metadata') {
                updateMetadataWithCountryData();
            }
        }

        // Show preview
        function showPreview() {
            document.getElementById('resultsPanel').style.display = 'none';
            document.getElementById('previewPanel').style.display = 'block';
        }

        // Update selection summary with trade direction
        function updateSelectionSummary() {
            // Countries summary
            const countriesSummary = document.getElementById('selectedCountriesSummary');
            if (selectedCountries.length === 0) {
                countriesSummary.textContent = 'Tanlanmagan';
                countriesSummary.style.color = 'var(--text-muted)';
            } else if (selectedCountries.length <= 3) {
                countriesSummary.textContent = selectedCountries.join(', ');
                countriesSummary.style.color = 'var(--accent-primary)';
            } else {
                countriesSummary.textContent =
                    `${selectedCountries.slice(0, 2).join(', ')} va yana ${selectedCountries.length - 2} ta`;
                countriesSummary.style.color = 'var(--accent-primary)';
            }

            // Series summary
            const seriesSummary = document.getElementById('selectedSeriesSummary');
            if (selectedSeries.length === 0) {
                seriesSummary.textContent = 'Tanlanmagan';
                seriesSummary.style.color = 'var(--text-muted)';
            } else if (selectedSeries.length <= 2) {
                const shortSeries = selectedSeries.map(s => s.length > 30 ? s.substring(0, 27) + '...' : s);
                seriesSummary.textContent = shortSeries.join(', ');
                seriesSummary.style.color = 'var(--accent-primary)';
            } else {
                const firstTwo = selectedSeries.slice(0, 2).map(s => s.length > 25 ? s.substring(0, 22) + '...' : s);
                seriesSummary.textContent = `${firstTwo.join(', ')} va yana ${selectedSeries.length - 2} ta`;
                seriesSummary.style.color = 'var(--accent-primary)';
            }

            // Trade Direction summary
            const tradeDirectionSummary = document.getElementById('selectedTradeDirectionSummary');
            if (selectedTradeDirections.length === 0) {
                tradeDirectionSummary.textContent = 'Tanlanmagan';
                tradeDirectionSummary.style.color = 'var(--text-muted)';
            } else {
                const directionNames = selectedTradeDirections.map(dir => {
                    return dir === 'export' ? 'Eksport' : 'Import';
                });
                tradeDirectionSummary.textContent = directionNames.join(', ');
                tradeDirectionSummary.style.color = 'var(--accent-primary)';
            }

            // Years summary
            const yearsSummary = document.getElementById('selectedYearsSummary');
            if (selectedYears.length === 0) {
                yearsSummary.textContent = 'Tanlanmagan';
                yearsSummary.style.color = 'var(--text-muted)';
            } else if (selectedYears.length <= 5) {
                yearsSummary.textContent = selectedYears.sort((a, b) => b - a).join(', ');
                yearsSummary.style.color = 'var(--accent-primary)';
            } else {
                const sortedYears = selectedYears.sort((a, b) => b - a);
                yearsSummary.textContent = `${sortedYears.slice(0, 3).join(', ')} va yana ${selectedYears.length - 3} ta`;
                yearsSummary.style.color = 'var(--accent-primary)';
            }

            console.log('✅ Selection summary updated with trade direction');
        }

        // Country selector functions
        function showChartControls() {
            document.getElementById('chartControls').style.display = 'block';
        }

        function showCountrySelector() {
            document.getElementById('countrySelectorSection').style.display = 'block';
            populateCountrySelector();
        }

        function populateCountrySelector() {
            if (!currentData.length) return;

            // Get unique countries from current data
            availableCountries = [...new Set(currentData.map(item => item.country || item.trading_partner))].filter(
                Boolean);
            availableCountries.sort();

            const selector = document.getElementById('countrySelector');

            // Clear existing options except "All"
            selector.innerHTML = '<option value="all">Barcha davlatlar</option>';

            // Add country options
            availableCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                selector.appendChild(option);
            });

            // Set default to first country if available
            if (availableCountries.length > 0) {
                selector.value = availableCountries[0];
                selectedCountryForView = availableCountries[0];
                updateViewByCountry();
            }

            console.log(`✅ Country selector populated with ${availableCountries.length} countries`);
        }

        // Chart functions with full implementation
        function updateChartWithCountryData() {
            const chartType = document.getElementById('chartType').value;
            const metric = document.getElementById('chartMetric').value;

            if (!countryFilteredData.length || !metric) {
                document.querySelector('.chart-content').innerHTML = `
                    <div class="chart-loading">
                        <div class="spinner"></div>
                        <p>Ma'lumot yoki metrik tanlanmagan</p>
                    </div>
                `;
                return;
            }

            // Destroy existing chart
            if (currentChart) {
                currentChart.destroy();
            }

            // Restore canvas if not exists
            const chartContent = document.querySelector('.chart-content');
            if (!document.getElementById('dataChart')) {
                chartContent.innerHTML = '<canvas id="dataChart"></canvas>';
            }

            const ctx = document.getElementById('dataChart').getContext('2d');

            // Prepare data for chart
            let chartData;
            if (selectedCountryForView === 'all') {
                chartData = prepareCountryComparisonData(metric);
            } else {
                chartData = prepareCountryTimelineData(countryFilteredData, metric);
            }

            // Chart configuration
            // Chart konfiguratsiyasini yangilang:

            const config = {
                type: chartType,
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    // Bu qismni o'zgartiring - faqat bitta nuqta uchun interaction
                    interaction: {
                        mode: 'point', // 'index' o'rniga 'point' qo'ying
                        intersect: true, // false o'rniga true qo'ying
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: getChartTitle(metric),
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary'),
                                font: {
                                    size: 11
                                },
                                usePointStyle: true,
                                padding: 15,
                                generateLabels: function(chart) {
                                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                    const labels = original.call(this, chart);

                                    labels.forEach(label => {
                                        if (label.text && label.text.length > 25) {
                                            label.text = label.text.substring(0, 22) + '...';
                                        }
                                    });

                                    return labels;
                                }
                            }
                        },
                        // Tooltip konfiguratsiyasini yangilang
                        tooltip: {
    mode: 'point',
    intersect: true,
    callbacks: {
        title: function(context) {
            if (context.length > 0) {
                return `${context[0].label}-yil`;
            }
            return '';
        },
        label: function(context) {
            const fullName = context.dataset.fullName || context.dataset.label;
            // Mahsulot nomini 40 ta belgidan ko'p bo'lsa qisqartirish
            const displayName = fullName.length > 40 ? 
                fullName.substring(0, 37) + '...' : fullName;
            const value = formatChartNumber(context.parsed.y);
            return `${displayName}: ${value}`;
        }
    },
    backgroundColor: 'rgba(0, 0, 0, 0.8)',
    titleColor: '#fff',
    bodyColor: '#fff',
    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--accent-primary'),
    borderWidth: 1,
    cornerRadius: 8,
    displayColors: true,
    titleFont: {
        size: 14,
        weight: 'bold'
    },
    bodyFont: {
        size: 12
    }
},
                    },
                    scales: chartType !== 'pie' ? {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Yillar',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                            },
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted')
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: getMetricLabel(metric),
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                            },
                            ticks: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                                callback: function(value) {
                                    return formatChartNumber(value);
                                }
                            },
                            grid: {
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-color')
                            }
                        }
                    } : {},
                    // Hover effektlarini sozlash
                    elements: {
                        point: {
                            hoverRadius: 8, // Hover paytida nuqta kattalashadi
                            hoverBorderWidth: 3,
                            radius: 4 // Oddiy holatda nuqta o'lchami
                        },
                        line: {
                            hoverBorderWidth: 3 // Hover paytida liniya qalinlashadi
                        }
                    }
                }
            };

            // Metrik o'lchov birligini qaytaruvchi yordamchi funksiya
            function getMetricUnit(metric) {
                const units = {
                    export_volume: 'kg/tons',
                    export_price: 'USD',
                    import_volume: 'kg/tons',
                    import_price: 'USD'
                };
                return units[metric] || '';
            }

            // Agar faqat o'sha liniyaning ma'lumotini ko'rsatishni istasangiz:
            // tooltip callback'ini yanada soddalashtirish mumkin:

            // ALTERNATIV VARIANT - faqat hover qilingan liniya ma'lumoti
            const alternativeTooltipConfig = {
                tooltip: {
                    mode: 'nearest', // Eng yaqin nuqtani topish
                    intersect: true,
                    callbacks: {
                        title: function(context) {
                            return `${context[0].label}-yil`;
                        },
                        label: function(context) {
                            const productName = context.dataset.fullName || context.dataset.label;
                            const value = context.parsed.y;
                            const formattedValue = formatChartNumber(value);

                            return `${productName}: ${formattedValue}`;
                        },
                        // Footer qo'shish (ixtiyoriy)
                        footer: function(tooltipItems) {
                            if (tooltipItems.length > 0) {
                                const context = tooltipItems[0];
                                const percentage = calculatePercentageChange(context);
                                return percentage ? [`O'zgarish: ${percentage}`] : [];
                            }
                            return [];
                        }
                    }
                }
            };

            // O'zgarish foizini hisoblash (ixtiyoriy qo'shimcha funksiya)
            function calculatePercentageChange(context) {
                const currentValue = context.parsed.y;
                const dataIndex = context.dataIndex;

                if (dataIndex > 0) {
                    const previousValue = context.dataset.data[dataIndex - 1];
                    if (previousValue && previousValue !== 0) {
                        const change = ((currentValue - previousValue) / previousValue) * 100;
                        return change > 0 ? `+${change.toFixed(1)}%` : `${change.toFixed(1)}%`;
                    }
                }
                return null;
            }
            currentChart = new Chart(ctx, config);
        }

        function prepareCountryComparisonData(metric) {
            const countryData = {};

            countryFilteredData.forEach(item => {
                const country = item.country || item.trading_partner || 'Unknown';
                const value = parseFloat(item[metric]) || 0;

                if (!countryData[country]) {
                    countryData[country] = 0;
                }
                countryData[country] += value;
            });

            const sortedCountries = Object.entries(countryData)
                .filter(([country, value]) => value > 0) // Only show countries with data
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const colors = [
                '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
                '#F97316', '#06B6D4', '#84CC16', '#EC4899', '#6B7280'
            ];

            return {
                labels: sortedCountries.map(item => item[0]),
                datasets: [{
                    label: getMetricLabel(metric),
                    data: sortedCountries.map(item => item[1]),
                    backgroundColor: colors.slice(0, sortedCountries.length),
                    borderColor: colors.slice(0, sortedCountries.length),
                    borderWidth: 2
                }]
            };
        }

function prepareCountryTimelineData(data, metric) {
    const productData = {};

    // Har bir mahsulot uchun yillik ma'lumotlarni to'plash
    data.forEach(item => {
        const productName = item.name || item.product_name || 'Noma\'lum';
        const year = item.year || 'Unknown';
        const value = parseFloat(item[metric]) || 0;

        if (value > 0) { // Faqat 0 dan katta qiymatlar
            if (!productData[productName]) {
                productData[productName] = {};
            }

            if (!productData[productName][year]) {
                productData[productName][year] = 0;
            }

            productData[productName][year] += value;
        }
    });

    // Har bir mahsulot uchun dataset yaratish
    const datasets = [];
    const colors = [
        '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
        '#F97316', '#06B6D4', '#84CC16', '#EC4899', '#6B7280',
        '#059669', '#DC2626', '#7C3AED', '#EA580C', '#0891B2'
    ];

    let colorIndex = 0;
    Object.entries(productData).forEach(([productName, yearData]) => {
        // Faqat 0 dan katta qiymatli yillarni olish
        const validDataPoints = Object.entries(yearData)
            .filter(([year, value]) => value > 0)
            .sort((a, b) => parseInt(a[0]) - parseInt(b[0])); // Yillar bo'yicha saralash

        if (validDataPoints.length > 0) {
            const shortName = productName.length > 30 ?
                productName.substring(0, 27) + '...' : productName;

            datasets.push({
                label: shortName,
                fullName: productName, // Tooltip uchun to'liq nom
                data: validDataPoints,
                borderColor: colors[colorIndex % colors.length],
                backgroundColor: colors[colorIndex % colors.length] + '20',
                borderWidth: 2,
                fill: false,
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 6,
                parsing: {
                    xAxisKey: '0', // year
                    yAxisKey: '1'  // value
                }
            });

            colorIndex++;
        }
    });

    // Barcha yillarni topish (faqat ishlatilgan yillar)
    const allYears = new Set();
    datasets.forEach(dataset => {
        dataset.data.forEach(point => allYears.add(point[0]));
    });

    const sortedYears = Array.from(allYears).sort();

    // Eng ko'p 10 ta mahsulotni ko'rsatish
    datasets.sort((a, b) => {
        const sumA = a.data.reduce((sum, point) => sum + point[1], 0);
        const sumB = b.data.reduce((sum, point) => sum + point[1], 0);
        return sumB - sumA;
    });

    return {
        labels: sortedYears,
        datasets: datasets.slice(0, 10)
    };
}
        function getChartTitle(metric) {
            const titles = {
                export_volume: 'Mahsulotlar bo\'yicha Eksport Hajmi',
                export_price: 'Mahsulotlar bo\'yicha Eksport Narxi',
                import_volume: 'Mahsulotlar bo\'yicha Import Hajmi',
                import_price: 'Mahsulotlar bo\'yicha Import Narxi'
            };

            let title = titles[metric] || 'Mahsulotlar bo\'yicha Ma\'lumotlar';

            if (selectedCountryForView !== 'all') {
                title = `${selectedCountryForView} - ${title}`;
            }

            return title;
        }

        function getMetricLabel(metric) {
            const labels = {
                export_volume: 'Eksport Hajmi',
                export_price: 'Eksport Narxi',
                import_volume: 'Import Hajmi',
                import_price: 'Import Narxi'
            };
            return labels[metric] || 'Qiymat';
        }

        function formatChartNumber(value) {
            if (value >= 1000000000) {
                return (value / 1000000000).toFixed(1) + 'B';
            } else if (value >= 1000000) {
                return (value / 1000000).toFixed(1) + 'M';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(1) + 'K';
            }
            return value.toFixed(0);
        }

        function updateChart() {
            updateChartWithCountryData();
        }

        function exportChart() {
            if (!currentChart) {
                showToast('⚠️ Xatolik', 'Grafik mavjud emas', 'error');
                return;
            }

            const url = currentChart.toBase64Image();
            const a = document.createElement('a');
            a.href = url;
            a.download = `imrs_chart_${new Date().toISOString().slice(0, 10)}.png`;
            a.click();

            showToast('✅ Yuklandi!', 'Grafik PNG formatida saqlandi', 'success');
        }

        // Metadata functions with full implementation
        function updateMetadataWithCountryData() {
            if (!countryFilteredData.length) {
                document.getElementById('totalRecords').textContent = '0 ta yozuv';
                document.getElementById('uniqueCountries').textContent = '0 ta davlat';
                document.getElementById('uniqueProducts').textContent = '0 ta mahsulot';
                document.getElementById('yearRange').textContent = '-';
                document.getElementById('totalExport').textContent = '0';
                document.getElementById('totalImport').textContent = '0';

                document.getElementById('countryStats').innerHTML = '<p class="no-data">Ma\'lumot topilmadi</p>';
                return;
            }

            // Basic statistics
            const totalRecords = countryFilteredData.length;
            const uniqueCountries = [...new Set(countryFilteredData.map(item => item.country || item.trading_partner))]
                .length;
            const uniqueProducts = [...new Set(countryFilteredData.map(item => item.name || item.product_name))].length;

            // Year range
            const years = countryFilteredData.map(item => parseInt(item.year)).filter(year => !isNaN(year));
            const minYear = Math.min(...years);
            const maxYear = Math.max(...years);

            // Totals based on selected trade directions
            let totalExport = 0;
            let totalImport = 0;

            if (selectedTradeDirections.length === 0 || selectedTradeDirections.includes('export')) {
                totalExport = countryFilteredData.reduce((sum, item) => sum + (parseFloat(item.export_volume) || 0), 0);
            }

            if (selectedTradeDirections.length === 0 || selectedTradeDirections.includes('import')) {
                totalImport = countryFilteredData.reduce((sum, item) => sum + (parseFloat(item.import_volume) || 0), 0);
            }

            // Update metadata display
            document.getElementById('totalRecords').textContent = `${totalRecords.toLocaleString()} ta yozuv`;
            document.getElementById('uniqueCountries').textContent = `${uniqueCountries} ta davlat`;
            document.getElementById('uniqueProducts').textContent = `${uniqueProducts} ta mahsulot`;
            document.getElementById('yearRange').textContent = years.length ? `${minYear} - ${maxYear}` : '-';
            document.getElementById('totalExport').textContent = formatNumber(totalExport);
            document.getElementById('totalImport').textContent = formatNumber(totalImport);

            // Generate statistics
            generateDetailedStats();
        }

        function generateDetailedStats() {
            const statsContainer = document.getElementById('countryStats');

            if (selectedCountryForView === 'all') {
                // Show country-wise statistics
                const countryStats = {};

                countryFilteredData.forEach(item => {
                    const country = item.country || item.trading_partner || 'Unknown';
                    if (!countryStats[country]) {
                        countryStats[country] = {
                            records: 0,
                            export: 0,
                            import: 0
                        };
                    }
                    countryStats[country].records++;

                    if (selectedTradeDirections.length === 0 || selectedTradeDirections.includes('export')) {
                        countryStats[country].export += parseFloat(item.export_volume) || 0;
                    }

                    if (selectedTradeDirections.length === 0 || selectedTradeDirections.includes('import')) {
                        countryStats[country].import += parseFloat(item.import_volume) || 0;
                    }
                });

                const sortedStats = Object.entries(countryStats)
                    .sort((a, b) => b[1].records - a[1].records)
                    .slice(0, 10);

                let html = '';
                sortedStats.forEach(([country, stats]) => {
                    html += `
                        <div class="stats-row">
                            <span class="stats-country">${country}</span>
                            <span class="stats-value">${stats.records} ta yozuv</span>
                        </div>
                    `;
                });

                statsContainer.innerHTML = html;
            } else {
                // Show product-wise statistics for selected country
                const productStats = {};

                countryFilteredData.forEach(item => {
                    const product = (item.name || item.product_name || 'Unknown').substring(0, 50);
                    if (!productStats[product]) {
                        productStats[product] = {
                            records: 0,
                            value: 0
                        };
                    }
                    productStats[product].records++;

                    // Use the first available metric value
                    if (selectedTradeDirections.includes('export') || selectedTradeDirections.length === 0) {
                        productStats[product].value += parseFloat(item.export_volume) || 0;
                    } else if (selectedTradeDirections.includes('import')) {
                        productStats[product].value += parseFloat(item.import_volume) || 0;
                    }
                });

                const sortedStats = Object.entries(productStats)
                    .sort((a, b) => b[1].value - a[1].value)
                    .slice(0, 10);

                let html = '';
                sortedStats.forEach(([product, stats]) => {
                    html += `
                        <div class="stats-row">
                            <span class="stats-country" title="${product}">${product.length > 30 ? product.substring(0, 27) + '...' : product}</span>
                            <span class="stats-value">${formatNumber(stats.value)}</span>
                        </div>
                    `;
                });

                statsContainer.innerHTML = html;
            }
        }

        // Export functions
        function showExportOptions() {
            const existingModal = document.getElementById('exportModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = 'exportModal';
            modal.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: var(--bg-secondary);
                border: 2px solid var(--border-color);
                border-radius: 16px;
                padding: 30px;
                box-shadow: 0 20px 60px var(--shadow-dark);
                z-index: 1001;
                min-width: 300px;
                text-align: center;
            `;

            modal.innerHTML = `
                <h3 style="margin: 0 0 20px 0; color: var(--text-primary);">
                    <i class="fas fa-download"></i> Export qilish
                </h3>
                <p style="margin: 0 0 25px 0; color: var(--text-secondary);">
                    Fayl formatini tanlang:
                </p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button onclick="exportResults('csv'); closeExportModal();" 
                            style="background: var(--accent-primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-file-csv"></i> CSV
                    </button>
                    <button onclick="exportResults('excel'); closeExportModal();" 
                            style="background: var(--success); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                </div>
                <button onclick="closeExportModal()" 
                        style="background: var(--text-muted); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 15px;">
                    Bekor qilish
                </button>
            `;

            // Create backdrop
            const backdrop = document.createElement('div');
            backdrop.id = 'exportBackdrop';
            backdrop.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            `;
            backdrop.onclick = closeExportModal;

            document.body.appendChild(backdrop);
            document.body.appendChild(modal);
        }

        function closeExportModal() {
            const modal = document.getElementById('exportModal');
            const backdrop = document.getElementById('exportBackdrop');
            if (modal) modal.remove();
            if (backdrop) backdrop.remove();
        }

        function exportResults(format = 'csv') {
            showToast('📊 Export', `${format.toUpperCase()} fayl yuklanmoqda...`, 'info');
            console.log(`💾 Exporting results as ${format}...`);
        }

        function formatPrice(value) {
            if (value === null || value === undefined || value === '' || value === 0) {
                return '0';
            }

            if (typeof value === 'string' && !isNaN(value) && value.trim() !== '') {
                value = parseFloat(value);
            }

            if (typeof value === 'number' && !isNaN(value)) {
                return value.toLocaleString('en-US', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 2
                });
            }

            return value;
        }

        // Helper functions
        function truncateText(text, length) {
            if (!text) return '-';
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function formatNumber(num) {
            if (!num || num === 0) return '0';
            return new Intl.NumberFormat('en-US').format(Math.round(num));
        }

        // Toast notification
        function showToast(title, message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<strong>${title}</strong><br>${message}`;

            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        console.log('✅ IMRS Enhanced Filter System with Export/Import Support Ready!');
    </script>
</body>

</html>
